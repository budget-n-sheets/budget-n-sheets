<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <?!= HtmlService2.htmlInclude("gas-common/htmlStyles"); ?>
  <?!= jsZxcvbn ?>
</head>

<body>
  <p>Enter a password to protect your backup. Password must be at least 8 characters long.</p>

  <form accept-charset="UTF-8" id="the_form" onsubmit="submitForm();">
    <table style="width: 100%;">
      <tr>
        <td>
          <input class="pass" id="pass" type="password" placeholder="Password" style="width: 100%;" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');" required>
        </td>
      </tr>
      <tr>
        <td>
          <input class="pass" id="re_pass" type="password" placeholder="Confirm password" style="width: 100%;" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');" required>
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <input type="checkbox" id="pass-vis"><label for="pass-vis">Show password</label>
        </td>
      </tr>
    </table>
  </form>

  <p>
    Your password strength: <span id="pass-strength" style="font-weight: bold;"></span><br>
    Estimated time to crack: <span id="pass-crack" style="font-weight: bold;"></span><br>
    <span class="error" id="warn" style="visibility: hidden;">Passwords do not match.</span>
  </p>

  <p><strong>Don’t lose your password!</strong> Budget n Sheets won’t be able to reset it or recover your backup data if you do.</p>

  <button class="action" id="b-Ok" type="submit" form="the_form" disabled>Ok</button>
  <button onclick="closeHost()">Cancel</button>

  <?!= HtmlService2.htmlInclude("gas-common/htmlJavaScript"); ?>
  <?!= containment8d4adafda11Frame(); ?>
  <script>
    $('.pass').on('input', function() {
      $('#warn').css('visibility', 'hidden');
      $('#b-Ok').prop('disabled', true);

      const pass = $('#pass').val();
      const re_pass = $('#re_pass').val();

      let status = re_pass === pass;
      if (re_pass !== '' && !status) $('#warn').css('visibility', 'visible');
      status = status && (pass.length > 7);
      $('#b-Ok').prop('disabled', !status);

      const result = zxcvbn(pass);
      let strength = '';
      switch (result.score) {
        case 0:
        case 1:
          strength = 'very weak';
          break;
        case 2:
          strength = 'weak';
          break;
        case 3:
          strength = 'good';
          break;
        case 4:
          strength = 'strong';
          break;
      }
      $('#pass-strength').empty().append(strength);
      $('#pass-crack').empty().append(result.crack_times_display.offline_slow_hashing_1e4_per_second);
    });

    $('#pass-vis').change(function() {
      if ($(this).prop('checked')) {
        $('#pass').attr('type', 'text');
        $('#re_pass').attr('type', 'text');
      } else {
        $('#pass').attr('type', 'password');
        $('#re_pass').attr('type', 'password');
      }
    });

    function submitForm() {
      if (zxcvbn($('#pass').val()).score < 3) {
        const response = window.confirm('Warning: The password you have chosen is weak. Are you sure you want to use this password?\n\nClick "Ok" to stop and change your password.\nClick "Cancel" to continue and use this password.');
        if (response) return;
      }

      $('button').prop('disabled', true);
      $('input').prop('disabled', true);

      google.script.run
        .withSuccessHandler(submitAftermath)
        .withFailureHandler(showError)
        .backupService($('#pass').val());
    }

    function submitAftermath(r) {
      if (r === 0) closeHost();
      else if (r === 1) alert('Invalid password.');
      else if (r === 2) alert('Something went wrong. Try again later.');

      $('button').prop('disabled', false);
      $('input').prop('disabled', false);
    }
  </script>
</body>

</html>
