<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<meta charset="UTF-8">
		<?!= htmlInclude("gas-common/htmlStyles"); ?>
		<style>
			td p {
				margin-top: 0;
				margin-bottom: 0;
				text-indent: 0;
				text-align: justify;
			}

			td.comment {
				border-bottom: none;
				padding-bottom: 0;
			}

			.table_row {
				display: table-row;
			}

			#header {
				height: 3.7em;
				width: 100%;
				border-bottom: 1px solid #dadbe0;
			}

			.header_table {
				display: table;
				width: inherit;
				height: inherit;
				text-align: center;
				border-collapse: separate;
				border-spacing: 13px 7px;
			}
			.header_tab {
				cursor: pointer;
				display: table-cell;
				vertical-align:middle;
				color: rgba(0, 0, 0, 0.54);
			}
			.header_tab.active {
				border-bottom: solid 2px;
			}

			.footer_table {
				display: table;
				width: 100%;
				border-collapse: separate;
				border-spacing: 7px;
				border-top: 1px solid #dadbe0;
			}
			.footer_cell {
				display: table-cell;
				vertical-align: middle;
			}
		</style>
	</head>
	<body>
		<div id="wrapper">
			<div id="header">
				<div class="header_table">
					<div class="table_row">
						<div class="header_tab active" id="tab_settings">
							<i class="material-icons-outlined md-24" title="Settings">settings</i>
						</div>
						<? if (hasEditors && isAdmin) { ?>
							<div class="header_tab" id="tab_admin">
								<i class="material-icons-outlined md-24" title="Group">group_work</i>
							</div>
						<? } ?>
						<div class="header_tab" id="tab_advanced">
							<i class="material-icons-outlined md-24" title="Advanced">build</i>
						</div>
					</div>
				</div>
			</div>

			<div id="content" style="margin-bottom:4.3em;">
				<div class="panel active" id="panel_Settings">
					<form class="asidebar" accept-charset="UTF-8">
						<table style="width:100%;">
							<tr>
								<td class="name"><label>Spreadsheet</label></td>
								<td><?= doc_name ?></td>
							</tr>
							<tr>
								<td class="name"><label>Financial year</label></td>
								<td><?= financial_year ?></td>
							</tr>
							<tr>
								<td class="name"><label for="initial_month">Initial month</label></td>
								<td>
									<select id="initial_month" required>
										<option value="0" selected>January</option>
										<option value="1">February</option>
										<option value="2">March</option>
										<option value="3">April</option>
										<option value="4">May</option>
										<option value="5">June</option>
										<option value="6">July</option>
										<option value="7">August</option>
										<option value="8">September</option>
										<option value="9">October</option>
										<option value="10">November</option>
										<option value="11">December</option>
									</select>
								</td>
							</tr>
						</table>
            <? if (isOperationActive) { ?>
						<table style="width:100%;margin-top:1.3em;">
							<tr>
								<th colspan="2"><span style="font-size:1.2em;">Financial Calendar</span></th>
							</tr>
							<? if (isCalendarEnabled) { ?>
								<? if (isAdmin) { ?>
									<tr>
										<td class="comment name"><label for="financial_calendar">Calendar</label></td>
										<td class="comment">
											<select id="financial_calendar" style="width: 157px" required>
												<option value="" selected>Disable</option>
												<? for (var i = 0; i < calendars_data.md5.length; i++) { ?>
													<option value=<?= calendars_data.md5[i] ?>><?= calendars_data.name[i] ?></option>
												<? } ?>
											</select>
										</td>
									</tr>
									<tr>
										<td class="secondary" colspan="2">
											* Calendar is not owned by you.
										</td>
									</tr>
								<? } else { ?>
									<tr>
										<td class="name"><label>Calendar</label></td>
										<td>
											<select disabled>
												<option selected>Restrict</option>
											</select>
										</td>
									</tr>
								<? } ?>
								<tr>
									<td colspan="2">
										<input class="options-calendar" type="checkbox" id="post_day_events" disabled><label for="post_day_events">Sync calendar to the spreadsheet</label>
									</td>
								</tr>
                <tr>
                  <td colspan="2">
                    <input class="options-calendar" type="checkbox" id="cash_flow_events" disabled><label for="cash_flow_events">Sync calendar to cash flow</label>
                  </td>
                </tr>
							<? } else { ?>
								<tr>
									<td>
										It seems like Google Calendar is not enable for your account. <a href="<?= home_wiki ?>/Financial-Calendar" target="_blank"><b>Learn more</b></a>
									</td>
								</tr>
							<? } ?>
						</table>
            <table style="width:100%;margin-top:1.3em;">
              <tr>
                <th colspan="2"><span style="font-size:1.2em;">Performance</span></th>
              </tr>
                <tr>
                  <td class="comment name" style="width: 100%;"><label for="optimize_load">Optimize spreadsheet load</label></td>
                  <td class="comment">
                    <select id="optimize_load" required>
                      <option value="enable" selected>Enable</option>
                      <option value="disable">Disable</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td colspan="2">
                    <p>Suspend calculations of old activities. This can improve overall spreadsheet performance and loading time.<br>
                    <a href="<?= home_wiki ?>" target="_blank"><b>Learn more</b></a></p>
                  </td>
                </tr>
            </table>
            <? }?>
					</form>
				</div>

				<div class="panel" id="panel_Advanced">
					<table style="width:100%;">
            <? if (!isOperationActive) { ?>
              <tr>
                <td class="comment name" style="width: 100%;"><label>Optimize spreadsheet load</label></td>
                <td class="comment"><button id="b-Optimize" class="create">Optimize</button></td>
              </tr>
              <tr>
                <td colspan="2">
                  <p>Suspend all calculations. This can improve overall spreadsheet performance and loading time.<br>
                  <a href="<?= home_wiki ?>" target="_blank"><b>Learn more</b></a></p>
                </td>
              </tr>
            <? } ?>
						<tr>
							<td class="comment name" style="width: 100%;"><label>Reset protected ranges</label></td>
							<td class="comment"><button id="b-Reset" class="create">Reset</button></td>
						</tr>
						<tr>
							<td colspan="2">
								<p>This can fix issues related with editable ranges affected by protection.<br>
								<a href="<?= home_wiki ?>/Step-by-step-Introduction#protected-sheets-and-ranges" target="_blank"><b>Learn more</b></a></p>
							</td>
						</tr>
						<? if (isAdmin) { ?>
							<tr>
								<td class="comment name" style="width: 100%;"><label>Reinstall triggers</label></td>
								<td class="comment"><button id="b-Reinstall" class="create">Reinstall</button></td>
							</tr>
							<tr>
								<td colspan="2">
									<p>This can fix issues related with the add-on's automatic update and maintenance.<br />
									<a href="<?= home_wiki ?>/Updates-&-Maintenance" target="_blank"><b>Learn more</b></a></p>
								</td>
							</tr>
							<tr>
								<td class="comment name" style="width: 100%;"><label>Deactivate add-on</label></td>
								<td class="comment"><button id="b-Deactivate" class="create">Deactivate</button></td>
							</tr>
							<tr>
								<td colspan="2">
									<p>Once you deactivate the add-on for spreadsheet <span style="font-weight:bold;"><?= doc_name ?></span>, there is no going back! Please be certain.<br />
									<a href="<?= home_wiki ?>/Deactivate-or-Uninstall-Budget-n-Sheets" target="_blank"><b>Learn more</b></a></p>
								</td>
							</tr>
						<? } else { ?>
							<tr>
								<td class="comment name" style="width: 100%;"><label>Uninstall triggers</label></td>
								<td class="comment"><button id="b-Uninstall" class="create">Uninstall</button></td>
							</tr>
							<tr>
								<td colspan="2">
									<p>This can fix issues related with the add-on's automatic update and maintenance.<br>
									<a href="<?= home_wiki ?>/Updates-&-Maintenance" target="_blank"><b>Learn more</b></a></p>
								</td>
							</tr>
						<? } ?>
					</table>
				</div>

				<? if (hasEditors && isAdmin) { ?>
					<div class="panel" id="panel_Admin">
						<table style="width:100%;">
							<tr>
								<td class="comment" colspan="2">
									<input id="isChangeableByEditors" type="checkbox" <?= isChangeableByEditors ?>><label for="isChangeableByEditors">Editors can change settings</label>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<p>Only you can select the <b>calendar</b>, <b>reinstall triggers</b>, and <b>deactivate the add-on</b>.</p>
								</td>
							</tr>
							<tr>
								<td class="comment name" style="width: 100%;">Transfer admin role</td>
								<td class="comment"><button id="b-Transfer" class="create">Transfer</button></td>
							</tr>
							<tr>
								<td colspan="2">
									<? if (isSharedDrive) { ?>
										<p>Transfers admin role to current owner of the spreadsheet.<br>
									<? } else { ?>
										<p>Transfers admin role to an editor of the spreadsheet.<br>
									<? } ?>
									<a href="<?= home_wiki ?>/Add-on-Settings#group" target="_blank"><b>Learn more</b></a></p>
								</td>
							</tr>
						</table>
					</div>
				<? } ?>
			</div>

			<div id="footer">
				<div class="current" id="footer_response" style="padding:0 7px;"></div>
					<div class="footer_table">
						<div class="table_row">
							<div class="footer_cell left" style="width:100%;">
								<button class="action" id="b-Save" disabled>Save</button>
							</div>
							<div class="footer_cell right">
								<div class="md-footer"><a href="<?= home_wiki ?>" target="_blank"><i class="material-icons md-24 md-click">help_outline</i></a></div>
							</div>
					</div>
				</div>
			</div>
		</div>
		<?!= htmlInclude("gas-common/htmlJavaScript"); ?>
		<script>
			$(document).ready(function() {
				$("#b-Save").click(saveSettings);
				<? if (isAdmin) { ?>
					$("#b-Deactivate").click(deactivateAddon);
					$("#b-Reinstall").click(reinstallTriggers);
					<? if (hasEditors) { ?>
						$("#b-Transfer").click(transferAdminRole);
					<? } ?>
				<? } else { ?>
					$("#b-Uninstall").click(uninstallTriggers);
				<? } ?>
        <? if (!isOperationActive) { ?>
          $("#b-Optimize").click(optimizeAll);
        <? } ?>
				$("#b-Reset").click(resetProtection);

				google.script.run.withSuccessHandler(loadSettings)
					.withFailureHandler(showError)
					.retrieveUserSettings();
			});

			$(document).on("click", ".header_tab", function() {
				if ($(this).hasClass("active")) return;

				var select = $(this).attr("id");

				$(this).addClass("active")
					.siblings()
					.removeClass("active");
				$("#b-Save").hide();

				window.scrollTo(0, 0);
				if (select === "tab_settings") {
					$("#b-Save").show();
					$("#panel_Settings").show()
						.siblings()
						.hide();
				} else if (select === "tab_advanced") {
					$("#panel_Advanced").show()
						.siblings()
						.hide();
				<? if (hasEditors && isAdmin) { ?>
					} else if (select === "tab_admin") {
						$("#panel_Admin").show()
							.siblings()
							.hide();
				<? } ?>
				}
			});

			<? if (isCalendarEnabled) { ?>
				$("#financial_calendar").change(function() {
					if ($(this).val() === "") {
						$(".options-calendar").prop("disabled", true);
						$(".options-calendar").prop("checked", false);
					} else {
						$(".options-calendar").prop("disabled", false);
					}
					return;
				});

			<? } ?>
			<? if (isAdmin) { ?>
				<? if (hasEditors) { ?>
					$("#isChangeableByEditors").change(function() {
						this.disabled = true;
						$("#footer_response").empty();
						google.script.run.withSuccessHandler(function(r, o) {
									o.disabled = false;
								})
							.withFailureHandler(showError)
							.withUserObject(this)
							.setAdminSettings("isChangeableByEditors", $(this).prop("checked"));
					});

					function transferAdminRole() {
						this.disabled = true;
						$("#footer_response").empty();

						google.script.run.withSuccessHandler(function(r, o) {
									o.disabled = false;
									if (!r) google.script.host.close();
								})
							.withFailureHandler(showError)
							.withUserObject(this)
							<? if (isSharedDrive) { ?>
								.askTransferAdminSd();
							<? } else { ?>
								.askTransferAdmin();
							<? } ?>
					}

				<? } ?>
				function deactivateAddon() {
					this.disabled = true;
					$("#footer_response").empty();

					google.script.run.withSuccessHandler(function(r, o) {
								if (r) google.script.host.close();
								o.disabled = false;
							})
						.withFailureHandler(showError)
						.withUserObject(this)
						.askDeactivation();
				}

				function reinstallTriggers() {
					this.disabled = true;
					$("#footer_response").empty();

					google.script.run.withSuccessHandler(function(r, o) {
								if (!r) showStatus("Reinstalled triggers");
								o.disabled = false;
							})
						.withFailureHandler(showError)
						.withUserObject(this)
						.askReinstallTriggersUi();
				}

			<? } else { ?>
				function uninstallTriggers() {
					this.disabled = true;
					$("#footer_response").empty();

					google.script.run.withSuccessHandler(function(r, o) {
								showStatus("Uninstalled triggers");
								o.disabled = false;
							})
						.withFailureHandler(showError)
						.withUserObject(this)
						.askDeleteAllTriggers();
				}

			<? } ?>
			function resetProtection() {
				this.disabled = true;
				$("#footer_response").empty();

				google.script.run.withSuccessHandler(function(r, o) {
							showStatus("Reseted protection");
							o.disabled = false;
						})
					.withFailureHandler(showError)
					.withUserObject(this)
					.askResetProtection();
			}

      function optimizeAll () {
        this.disabled = true;
        $("#footer_response").empty();

        google.script.run.withSuccessHandler(function(r, o) {
              if (!r) showStatus("Spreadsheet optimized");
              o.disabled = false;
            })
          .withFailureHandler(showError)
          .withUserObject(this)
          .askOptimizeAll();
      }

			function loadSettings(user_settings) {
				$("#initial_month").val(user_settings.initial_month);
        $("#optimize_load").val(user_settings.optimize_load);
				<? if (isCalendarEnabled) { ?>
					<? if (isAdmin) { ?>
						$("#financial_calendar").val(user_settings.financial_calendar);
						if (user_settings.financial_calendar) {
					<? } else { ?>
						if (user_settings.hasFinancialCalendar) {
					<? } ?>
						if (user_settings.post_day_events) $("#post_day_events").prop("checked", true);
						if (user_settings.cash_flow_events) $("#cash_flow_events").prop("checked", true);
						$(".options-calendar").prop("disabled", false);
					}
				<? } ?>

				$("#b-Save").prop("disabled", false);
			}

			function saveSettings() {
				this.disabled = true;
				$("#footer_response").empty();

				var user_settings = {
					<? if (isCalendarEnabled) { ?>
						<? if (isAdmin) { ?>
							financial_calendar: $("#financial_calendar").val(),
						<? } ?>
						post_day_events: $("#post_day_events").prop("checked"),
						cash_flow_events: $("#cash_flow_events").prop("checked"),
					<? } ?>
          initial_month: $("#initial_month").val(),
          optimize_load: $("#optimize_load").val()
				};

				google.script.run.withSuccessHandler(function(r, o) {
              if (r) showError()
							showStatus("Saved settings");
							o.disabled = false;
						})
					.withFailureHandler(showError)
					.withUserObject(this)
					.saveUserSettings(user_settings);
			}

			function showStatus(msg) {
				$("#footer_response").empty().append(msg);
			}
		</script>
	</body>
</html>
