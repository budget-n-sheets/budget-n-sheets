<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<meta charset="UTF-8">
		<?!= htmlInclude("gas-common/htmlStyles"); ?>
		<style>
			tr.advanced {
				display: none;
			}
			td.comment {
				border-bottom: none;
				padding-bottom: 0;
			}
			.MainMenu-bot_title {
				display: table;
				width: 100%;
				border-collapse: separate;
				border-spacing: 7px;
				background-color: #efefef;
				border-top: 2px solid #d9d9d9;
			}
			.MainMenu_row {
				display: table-row;
			}
			.m-footer {
				display: table-cell;
				vertical-align: middle;
			}
		</style>
	</head>
	<body>
		<div id="wrapper">
			<div id="content" style="margin-bottom:4.3em;">
				<form accept-charset="UTF-8">
					<table style="width:100%;">
						<tr>
							<th colspan="2"><span style="font-size:1.2em;">General</span></th>
						</tr>
						<tr>
							<td class="name" style="width:43%;"><label>Spreadsheet</label></td>
							<td><?= doc_name ?></td>
						</tr>
						<tr>
							<td class="name"><label>Financial year</label></td>
							<td><?= financial_year ?></td>
						</tr>
						<tr>
							<td class="name"><label for="initial_month">Initial month</label></td>
							<td>
								<select id="initial_month" required>
									<option value="0" selected>January</option>
									<option value="1">February</option>
									<option value="2">March</option>
									<option value="3">April</option>
									<option value="4">May</option>
									<option value="5">June</option>
									<option value="6">July</option>
									<option value="7">August</option>
									<option value="8">September</option>
									<option value="9">October</option>
									<option value="10">November</option>
									<option value="11">December</option>
								</select>
							</td>
						</tr>
					</table>
					<table style="width:100%;margin-top:1.3em;">
						<tr>
							<th colspan="2"><span style="font-size:1.2em;">Bill Calendar</span></th>
						</tr>
						<? if (calendars_enabled) { ?>
							<tr>
								<td class="comment name" style="width:37%;"><label for="financial_calendar">Calendar</label></td>
								<td class="comment">
									<select id="financial_calendar" required>
										<option value="" selected>Disabled</option>
										<? for (var i = 0; i < calendars_data.md5.length; i++) { ?>
											<option value=<?= calendars_data.md5[i] ?>><?= calendars_data.name[i] ?></option>
										<? } ?>
									</select>
								</td>
							</tr>
							<tr>
								<td class="secondary" colspan="2">
									* Calendar is not owned by you. <a href="https://github.com/guimspace/budget-n-sheets/wiki/Bill-Calendar#calendars-and-events-not-owned-by-you" target="_blank"><b>Learn more</b></a>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<input class="options-calendar" type="checkbox" id="post_day_events" disabled><label for="post_day_events">Sync calendar to spreadsheet</label>
								</td>
							</tr>
						<? } else { ?>
							<tr>
								<td>
									It seems like Google Calendar is not enable for your account. <a href="https://github.com/guimspace/budget-n-sheets/wiki/Bill-Calendar" target="_blank"><b>Learn more</b></a>
								</td>
							</tr>
						<? } ?>
					</table>
					<table style="width:100%;margin-top:1.3em;">
						<tr>
							<th colspan="2"><span style="font-size:1.2em;">Cash Flow</span></th>
						</tr>
						<? if (calendars_enabled) { ?>
							<tr>
								<td colspan="2">
									<input class="options-calendar" type="checkbox" id="cash_flow_events" disabled><label for="cash_flow_events">Sync calendar to cash flow</label>
								</td>
							</tr>
						<? } ?>
						<tr>
							<td colspan="2"><input type="checkbox" id="override_zero"><label for="override_zero">Tag zeros</label></td>
						</tr>
					</table>
				</form>
				<table style="width:100%;margin-top:1.3em;">
					<tr>
						<th style="width:100%;"><span style="font-size:1.2em;">Advanced</span></th>
						<th style="text-align:right;"><a id="b-ShowAdvanced">Show</a></th>
					</tr>
					<tr class="advanced">
						<td class="comment name"><label>Reset protected ranges</label></td>
						<td class="comment"><button id="b-Reset" class="create">Reset</button></td>
					</tr>
					<tr class="advanced">
						<td colspan="2">
								This can fix issues related with editable ranges affected by protection.<br>
								<a href="https://github.com/guimspace/budget-n-sheets/wiki/Step-by-step-Introduction#protected-sheets-and-ranges" target="_blank"><b>Learn more</b></a>
						</td>
					</tr>
					<tr class="advanced">
						<td class="comment name"><label>Reinstall triggers</label></td>
						<td class="comment"><button id="b-Reinstall" class="create">Reinstall</button></td>
					</tr>
					<tr class="advanced">
						<td colspan="2">
								This can fix issues related with the add-on's automatic update and maintenance.<br />
								<a href="https://github.com/guimspace/budget-n-sheets/wiki/Updates-&-Maintenance" target="_blank"><b>Learn more</b></a>
						</td>
					</tr>
					<tr class="advanced">
						<td class="comment name"><label>Deactivate add-on</label></td>
						<td class="comment"><button id="b-Deactivate" class="create">Deactivate</button></td>
					</tr>
					<tr class="advanced">
						<td colspan="2">
								Once you deactivate the add-on for spreadsheet <span style="font-weight:bold;"><?= doc_name ?></span>, there is no going back! Please be certain.<br />
								<a href="https://github.com/guimspace/budget-n-sheets/wiki/Frequently-Asked-Questions#how-do-i-deactivateuninstall-the-add-on" target="_blank"><b>Learn more</b></a>
						</td>
					</tr>
				</table>
			</div>
			<div id="footer">
				<div class="current" id="footer_response" style="padding:0 7px;"></div>
				<div class="MainMenu-bot_title"><div class="MainMenu_row">
						<div class="m-footer left" style="width:100%;">
							<button class="action" id="b-Save" disabled>Save</button>
						</div>
						<div class="m-footer right">
							<a id="i-help" href="https://github.com/guimspace/budget-n-sheets/wiki" target="_blank"><i class="material-icons md-click md-18">help</i></a>
						</div>
				</div></div>
			</div>
		</div>
		<?!= htmlInclude("gas-common/htmlJavaScript"); ?>
		<script>
			$(document).ready(function() {
				$("#b-ShowAdvanced").click(function(e) {
					this.remove();
					$("tr.advanced").fadeIn();
				});

				$("#b-Save").click(saveSettings);
				$("#b-Deactivate").click(deactivateAddon);
				$("#b-Reinstall").click(reinstallTriggers);
				$("#b-Reset").click(resetProtection);

				google.script.run.withSuccessHandler(loadSettings)
					.withFailureHandler(showError)
					.retrieveUserSettings();
			});

			<? if (calendars_enabled) { ?>
				$("#financial_calendar").change(function() {
					if ($(this).val() === "") {
						$(".options-calendar").prop("disabled", true);
						$(".options-calendar").prop("checked", false);
					} else {
						$(".options-calendar").prop("disabled", false);
					}
					return;
				});

			<? } ?>
			function deactivateAddon() {
				this.disabled = true;
				$("#footer_response").empty();

				google.script.run.withSuccessHandler(function(r, o) {
							if (r) google.script.host.close();
							o.disabled = false;
						})
					.withFailureHandler(showError)
					.withUserObject(this)
					.askDeactivation();
			}

			function resetProtection() {
				this.disabled = true;
				$("#footer_response").empty();

				google.script.run.withSuccessHandler(function(r, o) {
							showStatus("Reseted protection");
							o.disabled = false;
						})
					.withFailureHandler(showError)
					.withUserObject(this)
					.askResetProtection();
			}

			function reinstallTriggers() {
				this.disabled = true;
				$("#footer_response").empty();

				google.script.run.withSuccessHandler(function(r, o) {
							showStatus("Reinstalled triggers");
							o.disabled = false;
						})
					.withFailureHandler(showError)
					.withUserObject(this)
					.askReinstall();
			}

			function loadSettings(user_settings) {
				$("#initial_month").val(user_settings.initial_month);
				if (user_settings.override_zero) $("#override_zero").prop("checked", true);
				<? if (calendars_enabled) { ?>
					$("#financial_calendar").val(user_settings.financial_calendar);
					if (user_settings.financial_calendar != "") {
						if (user_settings.post_day_events) $("#post_day_events").prop("checked", true);
						if (user_settings.cash_flow_events) $("#cash_flow_events").prop("checked", true);
						$(".options-calendar").prop("disabled", false);
					}
				<? } ?>

				$("#b-Save").prop("disabled", false);
			}

			function saveSettings() {
				this.disabled = true;
				$("#footer_response").empty();

				var user_settings = {
					initial_month: $("#initial_month").val(),
					override_zero: $("#override_zero").prop("checked"),
					<? if (calendars_enabled) { ?>
						financial_calendar: $("#financial_calendar").val(),
						post_day_events: $("#post_day_events").prop("checked"),
						cash_flow_events: $("#cash_flow_events").prop("checked")
					<? } ?>
				};

				google.script.run.withSuccessHandler(function(r, o) {
							showStatus("Saved settings");
							o.disabled = false;
						})
					.withFailureHandler(showError)
					.withUserObject(this)
					.saveUserSettings(user_settings);
			}

			function showStatus(msg) {
				$("#footer_response").empty().append(msg);
			}
		</script>
	</body>
</html>
