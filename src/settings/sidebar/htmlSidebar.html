<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <?!= htmlInclude("gas-common/htmlStyles"); ?>
  <style>
    td p {
      margin-top: 0;
      margin-bottom: 0;
      text-indent: 0;
      text-align: justify;
    }

    td.comment {
      border-bottom: none;
      padding-bottom: 0;
    }

    #panel_Backup p {
      text-indent: 0;
    }

    .table_row {
      display: table-row;
    }

    #header {
      height: 3.7em;
      width: 100%;
      border-bottom: 1px solid #dadbe0;
    }

    .header_table {
      display: table;
      width: inherit;
      height: inherit;
      text-align: center;
      border-collapse: separate;
      border-spacing: 13px 7px;
    }

    .header_tab {
      cursor: pointer;
      display: table-cell;
      vertical-align: middle;
      color: rgba(0, 0, 0, 0.54);
    }

    .header_tab.active {
      border-bottom: solid 2px;
    }

    .footer_table {
      display: table;
      width: 100%;
      border-collapse: separate;
      border-spacing: 7px;
      border-top: 1px solid #dadbe0;
    }

    .footer_cell {
      display: table-cell;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div id="wrapper">
    <div id="header">
      <div class="header_table">
        <div class="table_row">
          <div class="header_tab active" id="tab_settings">
            <i class="material-icons-outlined md-24" title="Settings">settings</i>
          </div>
          <div class="header_tab" id="tab_maintenance">
            <i class="material-icons-outlined md-24" title="Maintenance">build</i>
          </div>
          <? if (settings_backup) { ?>
          <div class="header_tab" id="tab_backup">
            <i class="material-icons-outlined md-24" title="Backup">backup</i>
          </div>
          <? } ?>
        </div>
      </div>
    </div>

    <div id="content" style="margin-top: 7px;margin-bottom: 4.3em;">
      <div class="panel" id="panel_Maintenance">
        <table style="width:100%;">
          <tr>
            <th colspan="2"><span style="font-size:1.2em;">Maintenance</span></th>
          </tr>
          <tr>
            <td class="comment name" style="width: 100%;"><label>Reset protected ranges</label></td>
            <td class="comment"><button id="b-Reset">Reset</button></td>
          </tr>
          <tr>
            <td colspan="2">
              <p>This can fix issues related with editable ranges affected by protection.</p>
            </td>
          </tr>
          <tr>
            <td class="comment name" style="width: 100%;"><label>Reinstall triggers</label></td>
            <td class="comment"><button id="b-Reinstall">Reinstall</button></td>
          </tr>
          <tr>
            <td colspan="2">
              <p>This can fix issues related with the add-on's automatic update and maintenance.<br>
                <a href="<?= home_wiki ?>/Updates-&-Maintenance" target="_blank"><b>Learn more</b></a>
              </p>
            </td>
          </tr>
        </table>
        <? if (!isOwner || isSharedDrive) { ?>
        <table style="width:100%;margin-top:1.3em;">
          <tr>
            <th colspan="2"><span style="font-size:1.2em;">Add-on Admin</span></th>
          </tr>
          <tr>
            <td class="comment name" style="width: 100%;">Transfer add-on admin role</td>
            <td class="comment"><button id="b-Transfer">Transfer</button></td>
          </tr>
          <tr>
            <td colspan="2">
              <p>Transfers the role of add-on administrator in this spreadsheet.<br>
              <a href="<?= home_wiki ?>/Changing-Settings#transfer-add-on-admin-role" target="_blank"><b>Learn more</b></a></p>
            </td>
          </tr>
        </table>
        <? } ?>
      </div>

      <? if (settings_backup) { ?>
        <?!= htmlInclude("settings/sidebar/htmlPanelBackup"); ?>
      <? } ?>
    </div>

    <div id="footer">
      <div class="current" id="footer_response" style="padding:0 7px;"></div>
      <div class="footer_table">
        <div class="table_row">
          <div class="footer_cell left" style="width:100%;">
            <button class="action" id="b-Save" disabled>Save</button>
          </div>
          <div class="footer_cell right">
            <div class="md-footer"><a href="<?= home_wiki ?>/Changing-Settings" target="_blank"><i class="material-icons md-24 md-click">help_outline</i></a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <?!= htmlInclude("gas-common/htmlJavaScript"); ?>
  <script>
    $(document).ready(function() {
      $("#b-Reinstall").click(reinstallTriggers);
      <? if (!isOwner || isSharedDrive) { ?>
      $("#b-Transfer").click(transferAdminRole);
      <? } ?>

      $("#b-Reset").click(resetProtection);
    });

    $(document).on("click", ".header_tab", function() {
      if ($(this).hasClass("active")) return;

      var select = $(this).attr("id");

      $(this).addClass("active")
        .siblings()
        .removeClass("active");
      $('.footer_cell.left button').remove();

      window.scrollTo(0, 0);
      if (select === "tab_settings") {
        $('.footer_cell.left').append('<button class="action" id="b-Save">Save</button>');
        $("#panel_Settings").show()
          .siblings()
          .hide();
      } else if (select === "tab_maintenance") {
        $("#panel_Maintenance").show()
          .siblings()
          .hide();
      <? if (settings_backup) { ?>
      } else if (select === "tab_backup") {
        $('.footer_cell.left').append('<button id="b-Backup" class="action">Back up now</button>');
        $("#panel_Backup").show()
          .siblings()
          .hide();
      <? } ?>
      }
    });



    <? if (!isOwner || isSharedDrive) { ?>
    function transferAdminRole() {
      this.disabled = true;
      $("#footer_response").empty();

      google.script.run.withSuccessHandler(function(r, o) {
          o.disabled = false;
          if (!r) google.script.host.close();
        })
        .withFailureHandler(showError)
        .withUserObject(this)
        <? if (isSharedDrive) { ?>
        .askTransferAdminSd();
        <? } else { ?>
        .askTransferAdmin();
        <? } ?>
    }

    <? } ?>

    function reinstallTriggers() {
      this.disabled = true;
      $("#footer_response").empty();

      google.script.run.withSuccessHandler(function(r, o) {
          if (!r) showStatus("Reinstalled triggers");
          o.disabled = false;
        })
        .withFailureHandler(showError)
        .withUserObject(this)
        .askReinstallTriggersUi();
    }

    function resetProtection() {
      this.disabled = true;
      $("#footer_response").empty();

      google.script.run.withSuccessHandler(function(r, o) {
          showStatus("Reseted protection");
          o.disabled = false;
        })
        .withFailureHandler(showError)
        .withUserObject(this)
        .askResetProtection();
    }

    function showStatus(msg) {
      $("#footer_response").empty().append(msg);
    }
  </script>
  <? if (settings_backup) { ?>
    <?!= htmlInclude("settings/sidebar/jsPanelBackup"); ?>
  <? } ?>
</body>

</html>
