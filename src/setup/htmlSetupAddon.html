<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <?!= HtmlService2.htmlInclude("html/resources/styles"); ?>
  <?!= HtmlService2.htmlInclude("html/resources/containers"); ?>
  <?!= HtmlService2.htmlInclude("html/resources/material-icons"); ?>
  <?!= HtmlService2.htmlInclude("html/resources/animation-processing"); ?>
  <style>
    .content-container > div {
      display: none;
    }

    .panel#main-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .panel-main-header {
      margin-top: 3em;
    }
  </style>
  <style>
    table.start-options {
      border-collapse: collapse;
      font-size: 14px;
    }

    table.start-options tr {
      vertical-align: middle;
      cursor: pointer;
    }

    table.start-options tr:hover {
      background-color: #f3f3f3;
    }

    table.start-options td {
      padding: 11px 3px;
    }
  </style>
  <style>
    #form-panel table {
      margin-top: 0.7em;
    }

    #form-panel table td:first-child {
      width: 40%;
    }

    .panel-form-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .md-click {
      border-radius: 50%;
    }

    .md-click:hover {
      background: #f3f3f3;
    }

    .table-accounts {
      counter-reset: tr-count;
    }

    .table-accounts tr.num_acc {
      counter-increment: tr-count;
    }

    .acc_counter:after {
      content: ' ' counter(tr-count);
    }
  </style>
  <style>
    #timeout {
      display: none;
    }
  </style>
  <style>
    .animation-processing-wrapper {
      width: 190px;
    }

    .animation-processing-bar {
      width: 113px;
      animation-duration: 1493ms;
      animation-name: animateProcessingBar;
    }

    @keyframes animateProcessingBar {
      from {
        left: -257px;
      }

      to {
        left: 257px;
      }
    }
  </style>
</head>

<body>
  <div class="content-container">
    <div class="panel" id="main-panel">
      <div class="panel-main-header">
        <img height="103" src="https://raw.githubusercontent.com/guimspace/budget-n-sheets/master/media/icon/icon-large.png" alt="Budget n Sheets">
      </div>
      <h2 style="margin-bottom: 0;">Budget n Sheets</h2>
      <h3 class="gray" style="margin-top: 0.5em;font-style: italic;">Mind your budget</h3>
      <div style="margin-top: 1em;">
        <button class="action" style="width: 13em;" onclick="clickNext()">Start</button>
      </div>
      <div style="margin-top: 1em;">
        <a href="<?= privacy_policy ?>" target="_blank">Privacy Policy</a> and <a href="<?= terms_of_service ?>" target="_blank">Terms of Service</a>
      </div>
    </div>

    <div class="panel" id="note-panel">
      <h2>Attention</h2>
      <p>The build process will delete all tabs and data from the spreadsheet!</p>
      <p>If the spreadsheet has important or sensitive data that you care about, <a href="https://support.google.com/docs/answer/49114" target="_blank"><strong>make a copy or start a new spreadsheet</strong></a> before continuing, then restart the process.</p>
    </div>

    <div class="panel" id="restore-panel">
      <h2>Let's get started</h2>
      <table class="start-options">
        <tr class="comment" id="b-Continue">
          <td><span class="material-icons-outlined">new_releases</span></td>
          <td>
            <div>
              <strong>Set up as new</strong>
            </div>
            Get a new budget spreadsheet.
          </td>
        </tr>
        <? if (setup_copy) { ?>
        <tr class="comment" id="b-Copy">
          <td><span class="material-icons-outlined">content_copy</span></td>
          <td>
            <strong>Copy your data</strong><br>
            Copy content from an old budget spreadsheet.
          </td>
        </tr>
        <? } ?>
        <? if (setup_restore) { ?>
        <tr class="comment" id="b-Restore">
          <td><span class="material-icons-outlined">restore</span></td>
          <td>
            <strong>Restore your data</strong><br>
            Restore a budget spreadsheet from a backup.
          </td>
        </tr>
        <? } ?>
      </table>
    </div>

    <div class="panel" id="form-panel">
      <div class="panel-form-header">
        <h2>Spreadsheet specs</h2>
        <div>
          <a href="<?= home_wiki ?>/Getting-Started#2-start-a-budget-sheet" target="_blank"><span class="material-icons md-24 md-click">help_outline</span></a>
        </div>
      </div>

      <form accept-charset="UTF-8" id="the_form" onsubmit="return submitForm();">
        <table>
          <tr>
            <td><label for="spreadsheet_name">Spreadsheet title</label></td>
            <td><input type="text" id="spreadsheet_name" maxlength="128" required></td>
          </tr>
          <tr>
            <td><label for="decimal_places">Decimal places</label></td>
            <td><input id="decimal_places" type="number" value="2" min="0" max="16" step="1" placeholder="0" required></td>
          </tr>
        </table>
        <table>
          <tr>
            <th colspan="2"><span class="material-icons-outlined">calendar_today</span> Calendar</th>
          </tr>
          <tr>
            <td><label for="financial_year">Financial year</label></td>
            <td><input type="number" id="financial_year" min="1889" max="2111" step="1" required></td>
          </tr>
          <tr>
            <td><label for="initial_month">Initial month</label></td>
            <td>
              <select id="initial_month">
                <option value="0" selected>January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
              </select>
            </td>
          </tr>
        </table>
        <table class="table-accounts">
          <tr>
            <th colspan="3"><span class="material-icons-outlined">account_balance</span> Accounts</th>
          </tr>
          <tr class="num_acc">
            <td><label class="acc_counter">Account</label></td>
            <td>
              <input type="text" name="account_name" maxlength="64" placeholder="Name" required>
            </td>
            <td><span class="material-icons remove-acc" style="padding-left: 3px;visibility: hidden;cursor: pointer;">remove_circle</span></td>
          </tr>
          <tr id="addAcc">
            <td></td>
            <td>
              <input type="text" id="i-AddAcc" placeholder="Add account" readonly>
            </td>
            <td></td>
          </tr>
        </table>
      </form>
    </div>

    <div class="panel" id="setup-panel">
      <h2>Assembling your spreadsheet</h2>
      <div class="animation-processing-wrapper">
        <div class="animation-processing-bar"></div>
      </div>
      <p>This process takes up to two minutes. Do not edit the spreadsheet until it is finished.</p>
      <div id="timeout">
        It is taking too long. You can try again or <a href="<?= send_feedback ?>" target="_blank">report a problem</a>.
      </div>
    </div>
  </div>

  <div class="footer-container">
  </div>

  <?!= HtmlService2.htmlInclude("html/resources/javascript"); ?>
  <?!= containment8d4adafda11Frame(); ?>
  <script>
    const Glob = { num_acc: 1 };
    const uuid = <?= uuid ?>;
    var TIMEOUT_ID;

    $(document).ready(function() {
      $("#b-Continue").click(clickNext);
      <? if (setup_restore) { ?>
      $("#b-Restore").click(showRestore);
      <? } ?>
      <? if (setup_copy) { ?>
      $("#b-Copy").click(showCopy);
      <? } ?>
      $('#i-AddAcc').click(addAccInput);

      var date = new Date();
      $("#financial_year").val(date.getFullYear());
      if (date.getMonth() > 1) {
        $("#initial_month").val(date.getMonth() - 1);
      }

      $("#main-panel").fadeIn().addClass("active");
    });

    $(document).on('click', '.remove-acc', function() {
      if (Glob.num_acc === 1) return;

      $(this).closest('tr').remove();
      Glob.num_acc--;

      if (Glob.num_acc < 5) $('#addAcc').show();
      if (Glob.num_acc === 1) $('.remove-acc').css({ visibility: 'hidden' });
    });

    function addAccInput() {
      if (Glob.num_acc > 4) return;

      const $tr = $('<tr>').attr({ class: 'num_acc' });

      const $td1 = $('<td>').append([
        $('<label>').attr({ class: 'acc_counter' }).text('Account')
      ]);

      const $td2 = $('<td>').append([
        $('<input>').attr({
            type: 'text',
            name: 'account_name',
            placeholder: 'Name',
            required: true,
            maxlength: 64
          })
      ]);

      const $td3 = $('<td>');
      $('<span>').attr({ class: 'material-icons remove-acc' })
        .css({
          'padding-left': '3px',
          cursor: 'pointer',
          visibility: 'hidden'
        })
        .text('remove_circle')
        .appendTo($td3);

      $td1.appendTo($tr);
      $td2.appendTo($tr);
      $td3.appendTo($tr);

      $('#addAcc').before($tr);
      Glob.num_acc++;

      if (Glob.num_acc > 4) $('#addAcc').hide();
      if (Glob.num_acc > 1) $('.remove-acc').css({ visibility: 'visible' });

      $tr.find('input').focus();
    }

    <? if (setup_restore) { ?>
    function showRestore() {
      $("#restore-panel").fadeOut();
      google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(closeHost)
        .showDialogSetupRestore(uuid);
    }
    <? } ?>

    <? if (setup_copy) { ?>
    function showCopy() {
      $("#restore-panel").fadeOut();
      google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(closeHost)
        .showDialogSetupCopy(uuid);
    }
    <? } ?>

    function clickNext() {
      window.scrollTo(0, 0);

      var p = $(".active").attr("id");
      $("#" + p).removeClass("active");

      $(".panel").hide();
      $("#footer-buttons button").remove();

      switch (p) {
        case "main-panel":
          $("#note-panel").fadeIn("fast").addClass("active");
          $("#footer-buttons").append("<button class=\"action\" onclick=\"clickNext();\">Continue</button>");
          break;
        case "note-panel":
          $("#restore-panel").fadeIn("fast").addClass("active");
          break;
        case "restore-panel":
          $("#form-panel").fadeIn("fast").addClass("active");
          $("#footer-buttons").append("<button class=\"create\" type=\"submit\" form=\"the_form\">Build</button>");
          break;

        default:
          break;
      }
    }

    function submitForm() {
      const name_accounts = [];
      $('input[name=account_name]').each(function(index) {
        name_accounts.push({
          require: 'new',
          index: index,
          name: $(this).val()
        });
      });

      const payload = {
        protocol: 'new',
        config: {
          name_accounts: name_accounts,

          spreadsheet_name: $("#spreadsheet_name").val(),
          decimal_places: $("#decimal_places").val(),

          financial_year: $("#financial_year").val(),
          initial_month: $("#initial_month").val()
        }
      };

      TIMEOUT_ID = setTimeout(function() {
        google.script.host.setHeight(293);
        $("#timeout").fadeIn();
        $("#footer-buttons").append("<button onclick=\"closeHost()\">Close</button>");
      }, 120000);

      google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(null)
        .setupService(uuid, payload);

      window.scrollTo(0, 0);

      var p = $(".active").attr("id");
      $("#" + p).removeClass("active");

      $(".panel").hide();
      $("#footer-buttons button").remove();
      $("#setup-panel").fadeIn("fast").addClass("active");
      google.script.host.setHeight(233);
    }
  </script>
</body>

</html>
