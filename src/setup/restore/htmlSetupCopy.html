<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <?!= HtmlService2.htmlInclude("gas-common/htmlStyles"); ?>
  <?!= HtmlService2.htmlInclude('gas-common/htmlMaterialIcons'); ?>
  <style>
  </style>
</head>

<body>
  <div id="wrapper">
    <div id="content">
      <div class="panel active" id="restore-panel">
        <div>
          <ol style="padding-left: 16px;">
            <li>Select a spreadsheet to copy data from.</li>
            <li>Review the settings and make your changes.</li>
            <li>Click <strong>COPY</strong>.</li>
          </ol>

          <p class="error" id="reponse"><?= msg ?></p>
          <button class="action" id="b-Select">Select spreadsheet</button>
          <button onclick="closeHost()">Cancel</button>
        </div>

        <form accept-charset="UTF-8" id="the_form" onsubmit="submitForm();">
          <div class="panel" id="details">
            <table style="margin-top: 1.3em;">
              <tr>
                <th colspan="2"><i class="material-icons-outlined">table_chart</i> Spreadsheet</th>
              </tr>
              <tr>
                <td class="name" style="width: 127px;">Spreadsheet name</td>
                <td id="spreadsheet_name"></td>
              </tr>
              <tr>
                <td class="name" style="width: 127px;">Financial year</td>
                <td><input type="number" id="financial_year" style="width:61px;" min="1889" max="2111" step="1" required></td>
              </tr>
              <tr>
                <td class="name">Initial month</td>
                <td id="initial_month"></td>
              </tr>
            </table>

            <table style="margin-top: 1.3em;">
              <tr>
                <th><span class="material-icons-outlined">account_balance</span></th>
                <th colspan="2" style="width: 100%;">Accounts</th>
              </tr>
              <tbody id="accSortable">
              </tbody>
              <tr id="addAcc">
                <td></td>
                <td>
                  <input type="text" id="i-AddAcc" style="width: 100%;" placeholder="Add account" readonly>
                </td>
                <td></td>
              </tr>
            </table>

            <table style="width: 100%;margin-top: 2em;">
              <tr>
                <th></th>
                <th>
                  From spreadsheet<br>
                  <span class="error" id="accError"></span>
                </th>
              </tr>
              <tbody id="accRemoved">
              </tbody>
            </table>

            <table style="margin-top: 2em;">
              <tr>
                <th colspan="2"><i class="material-icons-outlined">assignment</i> Cards and tags</th>
              </tr>
              <tr>
                <td class="name">Cards</td>
                <td id="cards"></td>
              </tr>
              <tr>
                <td class="name">Tags</td>
                <td id="tags"></td>
              </tr>
            </table>

            <div style="margin-top: 1.3em;">
              <button class="create" id="b-Copy" type="submit" form="the_form" disabled>Copy</button>
            </div>
          </div>
        </form>
      </div>

      <div class="panel" id="setup-panel">
        <div style="width:100%;margin:40px auto 0 auto;" align="center">
          <h2>Copying your spreadsheet</h2>
          <br>
          <div class="wait_load-wrapper">
            <div class="wait_load-bar"></div>
          </div>
          <div style="width:263px;margin-top:19px;">
            This process takes up to 4 minutes. Do not edit the spreadsheet until it is finished.
          </div>
        </div>
        <div id="timeout" style="display: none;margin-top: 2em;">
          This is taking too long. You can try again or <a href="<?= send_feedback ?>" target="_blank">report a problem</a>.<br>
          <button onclick="closeHost()">Close</button>
        </div>
      </div>

      <div class="panel" id="error-panel">
        <p style="font-size: 1.3em;">Sorry, something went wrong. Please try again.</p>
        <p>An error report was sent anonymously.</p>
        <a href="<?= send_feedback ?>" target="_blank"><b>Send feedback</b></a>
      </div>
    </div>
  </div>

  <?!= HtmlService2.htmlInclude("gas-common/htmlJavaScript"); ?>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script>
    const uuid = <?= uuid ?>;
    const Glob = {
      timeout_id: 0,
      accounts: {},
      num_acc: 0
    };

    $(document).ready(function() {
      $('#b-Select').click(pickFile);
      <? if (isValid) { ?>
      $('#b-Select').prop('disabled', true);

      $("#i-AddAcc").click(() => addAccInput());
      $('#accSortable').sortable({
        axis: 'y',
        handle: '.handle',
        opacity: 0.71
      });

      google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(refreshInfo)
        .restrieveSettingsSummary(uuid, 'copy');
      <? } ?>
    });

    <? if (isValid) { ?>
    function refreshInfo(info) {
      if (!info) return;
      $('#b-Select').prop('disabled', false);

      $("#spreadsheet_name").append(info.settings.spreadsheet_title);
      $('#financial_year').val(info.settings.financial_year);
      $('#initial_month').append(info.settings.initial_month);

      $('#cards').append(info.misc.cards);
      $('#tags').append(info.misc.tags);

      info.settings.accounts.forEach((name, i) => {
        const key = 'acc' + i;
        Glob.accounts[key] = name;
        addAccInput(key);
      });

      $('#details').fadeIn('fast');
      $('#b-Copy').prop('disabled', false);
    }

    $(document).on('click', '.add-acc', function() {
      $('#accError').empty();
      if (Glob.num_acc > 4) {
        $('#addAcc').hide();
        $('#accError').append('No slot available.');
        return;
      };

      const key = $(this).attr('id');
      $(this).closest('tr').remove();
      addAccInput(key);
    });

    $(document).on('click', '.remove-acc', function() {
      $('#accError').empty();
      if (Glob.num_acc === 1) return;

      const key = $(this).attr('id');
      if (key) deselectAcc(key);

      $(this).closest('tr').remove();
      Glob.num_acc--;

      if (Glob.num_acc < 5) $('#addAcc').show();
      if (Glob.num_acc === 1) $('.remove-acc').css({ visibility: 'hidden' });
    });

    function addAccInput(key) {
      $('#accError').empty();
      if (Glob.num_acc > 4) return;

      const $tr = $('<tr>').attr({ class: 'num_acc' });
      let $el = null;

      const $td1 = $('<td>');
      $el = $('<span>').attr({class: 'material-icons remove-acc'})
        .css({
          visibility: 'hidden',
          cursor: 'pointer',
          'padding-right': '3px'
        })
        .text('remove_circle')
        .appendTo($td1);
      if (key) $el.attr('id', key);
      $td1.append($el);


      const $td2 = $('<td>').css({ width: '100%' });
      $el = $('<input>').attr({
          type: 'text',
          name: 'account_name',
          placeholder: 'Name',
          required: true
        })
        .css({ width: '100%' });
      if (key) {
        $el.attr({
          value: Glob.accounts[key],
          disabled: true,
          readonly: true
        });
      }
      $td2.append($el);

      const $td3 = $('<td>');
      $('<span>').attr({ class: 'material-icons handle' })
        .css({ cursor: 'grabbing' })
        .text('drag_handle')
        .appendTo($td3);

      $td1.appendTo($tr);
      $td2.appendTo($tr);
      $td3.appendTo($tr);

      $('#accSortable').append($tr);
      Glob.num_acc++;

      if (Glob.num_acc > 4) $('#addAcc').hide();
      if (Glob.num_acc > 1) $('.remove-acc').css({ visibility: 'visible' });

      if (!key) $tr.find('input').focus();
    }

    function deselectAcc(key) {
      const $tr = $('<tr>');

      const $td1 = $('<td>');
      $('<span>').attr({ class: 'material-icons add-acc', id: key })
        .css({ cursor: 'pointer' })
        .text('add_circle')
        .appendTo($td1);

      const $td2 = $('<td>').css({ width: '100%' });
      $('<input>').attr({
          type: 'text',
          value: Glob.accounts[key],
          disabled: true,
          readonly: true
        })
        .css({ width: '100%' })
        .appendTo($td2);

      $td1.appendTo($tr);
      $td2.appendTo($tr);

      $('#accRemoved').append($tr);
    }

    function submitForm() {
      $('#b-Copy').prop('disabled', true);
      window.scrollTo(0, 0);
      $('#accError').empty();

      $(".panel").hide();
      $("#setup-panel").fadeIn("fast").addClass("active");
      google.script.host.setHeight(233);

      Glob.timeout_id = setTimeout(function() {
        google.script.host.setHeight(293);
        $("#timeout").fadeIn();
      }, 240000);

      const name_accounts = [];
      $("input[name=account_name]").each(function() {
        const name = $(this).val();
        if (name) name_accounts.push(name);
      });

      const payload = {
        protocol: 'copy',
        config: {
          financial_year: $('#financial_year').val(),
          name_accounts: name_accounts
        }
      };

      google.script.run
        .withFailureHandler(panelError)
        .withSuccessHandler(null)
        .setupService(uuid, payload);
    }
    <? } ?>

    function pickFile() {
      this.disabled = true;
      google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(closeHost)
        .showDialogPickerRestore(uuid, 'copy');
    }

    function panelError(err) {
      clearTimeout(Glob.timeout_id);
      google.script.host.setHeight(197);
      $("#error-panel").siblings().remove();
      $("#error-panel").fadeIn("fast").addClass("active");
      $("#footer-buttons").append("<button onclick=\"closeHost();\">Close</button>");
    }
  </script>
</body>

</html>
