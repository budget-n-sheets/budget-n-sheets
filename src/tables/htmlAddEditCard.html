<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <?!= HtmlService2.htmlInclude("gas-common/htmlStyles"); ?>
  <style>
    #footer {
      display: table;
    }

    #footer2 {
      display: table-row;
    }

    #footer3 {
      display: table-cell;
      height: 3.7em;
      padding: 7px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div id="wrapper">
    <div id="content" style="margin-bottom:4.7em;">
      <form accept-charset="UTF-8" id="the_form" onsubmit="submitForm();">
        <table style="width:100%;">
          <tr>
            <th colspan="2">
              Details
            </th>
          </tr>
          <tr>
            <td class="name">
              <label for="card_name">Name</label>
            </td>
            <td>
              <input id="card_name" type="text" maxlength="64" required>
            </td>
          </tr>
          <tr>
            <td class="name" style="vertical-align:top;">
              <label for="card_code">Code</label>
            </td>
            <td>
              <input id="card_code" type="text" maxlength="32" pattern="^\S+$" required>
            </td>
          </tr>
          <tr>
            <td class="name" style="vertical-align:top;">
              <label for="card_aliases">Code aliases</label>
            </td>
            <td>
              <input id="card_aliases" type="text" maxlength="256" pattern="^\S+(\s+\S+)*$">
              <br>
              <span class="gray">Separate aliases with whitespace.</span>
            </td>
          </tr>
          <tr>
            <td class="name">
              <label for="card_limit">Credit limit</label>
            </td>
            <td>
              $ <input id="card_limit" style="width: 7.3em;" type="number" value="0" min="0" step="<?= step ?>" placeholder="<?= placeholder ?>" required>
            </td>
          </tr>
        </table>
        <? if (is_edit) { ?>
        <input id="card_id" style="display: none;" type="text" value="<?= card_id ?>">
        <? } ?>
      </form>
    </div>

    <div id="footer">
      <div class="current" id="response" style="padding:0 7px;"></div>
      <div id="footer2">
        <div id="footer3">
          <? if (is_edit) { ?>
          <button class="action" id="b-Submit" type="submit" form="the_form">Save</button>
          <? } else { ?>
          <button class="create" id="b-Submit" type="submit" form="the_form">Add</button>
          <? } ?>
          <button onclick="closeHost();">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <?!= HtmlService2.htmlInclude("gas-common/htmlJavaScript"); ?>
  <script>
    <? if (is_edit) { ?>
      $(document).ready(function() {
        google.script.run
          .withSuccessHandler(card => {
            if (!card) showError();

            $("#card_name").val(card.name);
            $("#card_code").val(card.code);
            $("#card_aliases").val(card.aliases.join(' '));
            $("#card_limit").val(card.limit);
          })
          .withFailureHandler(showError)
          .cardsClientService({
            job: 'get',
            id: $('#card_id').val()
          });
      });
    <? } ?>

    function submitForm() {
      $("#response").empty();
      $("#b-Submit").prop("disabled", true);

      const payload = {
        <? if (is_edit) { ?>
        job: 'update',
        id: $("#card_id").val(),
        <? } else { ?>
        job: 'create',
        <? } ?>
        metadata: {
          name : $("#card_name").val(),
          code : $("#card_code").val(),
          aliases: $("#card_aliases").val(),
          limit: $("#card_limit").val()
        }
      };

      google.script.run
        .withSuccessHandler(submitAftermath)
        .withFailureHandler(showError)
        .cardsClientService(payload);
    }

    function submitAftermath(r) {
      $("#response").empty();

      var response;
      switch (r) {
        case 1:
          response = "Sorry, something went wrong. Please, try again.";
          break;
        case 10:
          response = "The code has an invalid format.";
          break;
        case 11:
          response = "The code is already in use.";
          break;

        default:
          break;
      }

      if (r) {
        $("#response").append(response);
        $("#b-Submit").prop("disabled", false);
        return;
      }

      google.script.run
        .withSuccessHandler(closeHost)
        .showPanelTables();
    }
  </script>
</body>

</html>
