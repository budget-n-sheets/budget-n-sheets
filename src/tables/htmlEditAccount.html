<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <?!= HtmlService2.htmlInclude("html/resources/styles"); ?>
  <?!= HtmlService2.htmlInclude("html/resources/containers"); ?>
  <style>
    .footer {
      padding: 5px;
    }
  </style>
</head>

<body>
  <div class="content-container">
    <form accept-charset="UTF-8" id="the_form" onsubmit="submitForm()">
      <table>
        <tr>
          <th colspan="2">
            Details
          </th>
        </tr>
        <tr>
          <td>
            <label for="acc_name">Name</label>
          </td>
          <td>
            <input id="acc_name" type="text" maxlength="64" required disabled>
          </td>
        </tr>
        <tr>
          <td>
            <label for="acc_time_start">Initial month</label>
          </td>
          <td>
            <select id="acc_time_start" style="width: 83px;" disabled>
              <option value="0" selected>January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            <label for="acc_balance">Initial balance</label>
          </td>
          <td>
            $ <input id="acc_balance" type="number" value="0" step="<?= step ?>" placeholder="<?= placeholder ?>" required disabled>
          </td>
        </tr>
      </table>
      <input id="account_id" style="display: none;" type="text" value="<?= account_id ?>">
    </form>
  </div>

  <div class="footer">
    <span class="current" id="response"></span>
    <div>
      <button class="action" type="submit" form="the_form" disabled>Save</button>
      <button onclick="closeHost()">Cancel</button>
    </div>
  </div>

  <?!= HtmlService2.htmlInclude("html/resources/javascript"); ?>
  <script>
    $(document).ready(function() {
      google.script.run
        .withSuccessHandler(account => {
          if (!account) showError();

          $('input, textarea, select, button').prop('disabled', false);

          $('#acc_name').val(account.name);
          $('#acc_time_start').val(account.time_start);
          $('#acc_balance').val(account.balance);
        })
        .withFailureHandler(showError)
        .accountsClientService({
          job: 'get',
          id: $('#account_id').val()
        });
    });

    function submitForm () {
      $('.current').empty();

      const payload = {
        job: 'update',
        id: $('#account_id').val(),
        metadata: {
          name: $('#acc_name').val(),
          time_start: $('#acc_time_start').val(),
          balance: $('#acc_balance').val()
        }
      };

      $('input, textarea, select, button').prop('disabled', true);
      google.script.run
        .withSuccessHandler(submitAftermath)
        .withFailureHandler(showError)
        .accountsClientService(payload);
    }

    function submitAftermath (r) {
      $('.current').text(r ? 'Sorry, something went wrong. Please, try again.' : '');

      if (r) {
        $('input, textarea, select, button').prop('disabled', false);
        return;
      }

      google.script.run
        .withSuccessHandler(closeHost)
        .showPanelTables();
    }
  </script>
</body>

</html>
