<script>
  $(document).ready(function() {
    google.script.run
      .withSuccessHandler(listCards)
      .withFailureHandler(showError)
      .cardsClientService({ job: 'list' });
  });

  $(document).on("click", ".c-edit", function(e) {
    google.script.run
      .withSuccessHandler(responseHandler)
      .withFailureHandler(showError)
      .showDialogEditCard($(this).parent().attr("id"));
  });

  $(document).on("click", ".c-remove", function(e) {
    google.script.run
      .withSuccessHandler(reloadListCards)
      .withFailureHandler(showError)
      .showDialogDeleteCard($(this).parent().attr("id"));
  });

  $(".c-add-card").click(function(e) {
    google.script.run
      .withFailureHandler(showError)
      .showDialogAddCard();
  });

  function reloadListCards(r) {
    if (!r) return;

    $(".c-add-card").show();
    $('#panel-cards > hr').remove();
    $("#panel-cards > div:not(:last-child)").remove();

    google.script.run
      .withSuccessHandler(listCards)
      .withFailureHandler(showError)
      .cardsClientService({ job: 'list' });
  }

  function listCards(db_cards) {
    const $box = $('#panel-cards');

    for (const id in db_cards) {
      const $text = $('<div>').attr({class: 'text'}).append([
        $('<strong>').text(db_cards[id].name)
      ]);
      const $icons = $('<div>').attr({class: 'md-box', id: id}).append([
        $('<span>').attr({class: 'c-edit material-icons md-18'}).text('edit'),
        $('<span>').attr({class: 'c-remove material-icons md-18'}).text('delete')
      ]);

      $box.prepend($('<div>').attr({class: 'item'}).append([$text, $icons]));
    }

    if (Object.keys(db_cards).length >= 10) $('.c-add-card').hide();
    $('#panel-cards > div:not(:first-child)').before('<hr>');
  }
</script>
