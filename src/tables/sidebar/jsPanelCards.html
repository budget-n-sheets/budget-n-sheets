<script>
  $(document).ready(function() {
    google.script.run
      .withSuccessHandler(listCards)
      .withFailureHandler(showError)
      .cardsClientService({ job: 'list' });
  });

  $(document).on("click", ".c-edit", function(e) {
    $("#response").empty();
    google.script.run
      .withSuccessHandler(responseHandler)
      .withFailureHandler(showError)
      .showDialogEditCard($(this).parent().attr("id"));
  });

  $(document).on("click", ".c-remove", function(e) {
    $("#response").empty();
    google.script.run
      .withSuccessHandler(reloadListCards)
      .withFailureHandler(showError)
      .showDialogDeleteCard($(this).parent().attr("id"));
  });

  $("#b-AddCard").click(function(e) {
    $("#response").empty();
    google.script.run
      .withFailureHandler(showError)
      .showDialogAddCard();
  });

  function reloadListCards(r) {
    if (!r) return;
    $("#item-AddCard").hide();
    $("#box_Cards").empty();
    google.script.run
      .withSuccessHandler(listCards)
      .withFailureHandler(showError)
      .cardsClientService({ job: 'list' });
  }

  function listCards(db_cards) {
    for (const id in db_cards) {
      const card = db_cards[id];

      let item = "<div class=\"table_row\">";
      item += "<div class=\"item_cell\" style=\"font-size: 23px;\">" + card.name + "</div>";
      item += "</div>";

      item += "<div class=\"table_row\">";
      item += "<div class=\"item_cell\" style=\"border-bottom: 1px solid #d9d9d9;font-size: 14px;line-height: 1.3;\">";
      item += "Code: " + card.code + "<br>";
      item += "Credit limit: " + FormatNumber.financial(card.limit);
      if (card.aliases.length > 0) {
        item += "<br>";
        item += "Code aliases: " + card.aliases.join(", ");
      }
      item += "</div>";
      item += "</div>";

      item += "<div class=\"table_row\">";
      item += "<div class=\"item_cell item_menu\" id=\"" + id + "\">";
      item += "<a class=\"c-edit\">Edit</a> ";
      item += "<a class=\"c-remove\">Remove</a>";
      item += "</div>";
      item += "</div>";

      item = "<div class=\"item_table\">" + item + "</div>"
      $("#box_Cards").append(item);
    }

    if (Object.keys(db_cards).length < 10) $("#item-AddCard").show();
  }
</script>
